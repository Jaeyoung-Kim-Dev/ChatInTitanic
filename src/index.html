<!DOCTYPE html>
<script type="text/javascript"
        src="http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js"></script> <!--to use jQuery for messages.js-->
<!--<script type="text/javascript" src="./messages.js"></script>-->

<link rel="stylesheet" href="style.css">

<!--bootstrap begins-->
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css"
      integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">
<script src="https://code.jquery.com/jquery-3.5.1.min.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
        integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
        crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"
        integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI"
        crossorigin="anonymous"></script>
<!--bootstrap ends-->

<script src="/socket.io/socket.io.js"></script>

<script>  // for socket only. The rest javascript is in messages.js
    const socket = io();  // to receive data from server.js without refreshing the page.

    socket.on('message', (newMgs) => {  // when get a new message from 'server.js', it add messages and scroll down to the bottom
        addMessages(newMgs);
        scrollSmoothToBottom('main');
    })

    socket.on('refreshScreen', () => {
        $("#messages").html(""); // clear the preload messages before displaying default messages
        getMessages();
    })

$(() => {
    $("#send").click(() => {  // send a message
        const message = {
            name: $("#name").html(),
            message: $("#message").val(),
            // date will be added in server.js
        };
        postMessage(message);
        $("#message").val("");  // empty textarea 'message'
    });

    $("#reset").click(() => {  // reset DB
        let resetDB = confirm("Your comments are saved in online database server permanently, so if you want to reset the chatting then press the 'RESET' button.");
        if (resetDB) {
            $.post('http://localhost:3000/reset')
        }
    });

    $(".dropdown-menu a").click(function () { // When select the person name, the dropdown displays the name. Used regular function (not arrow) to use 'this'
        $(this).parents(".dropdown").find('.btn').html($(this).text());
        $(this).parents(".dropdown").find('.btn').val($(this).data('value'));
    });

    $(document).ready(() => {  // The first name is selected as default.
        $(".dropdown .dropdown-menu a")[0].click();
    });

    getMessages();
})

const addMessages = (message) => {
    const profile = "photo/" + message.name + ".jpeg";
    const template = `
            <div class="pic m-1">
                <img src=${profile} class="img-thumbnail rounded-circle" style="max-height: 80px; max-width: 80px" alt="profile">
            </div>
            <div class="col m-1">
                <div class="row">
                    <p class="font-weight-bold h5">
                        ${message.name}
                        <span class="text-muted small">${message.date}</span>
                    </p>
                </div>
                <p class="row">${message.message}</p>
                </div><div class="w-100">
            </div>`
    $("#messages").append(template)
}

const getMessages = () => {
    $.get('http://localhost:3000/messages', (data) => {
        data.forEach(addMessages);
        scrollSmoothToBottom('main');
    })
}

const postMessage = (message) => {
    $.post('http://localhost:3000/messages', message)
}

const scrollSmoothToBottom = (id) => {  // to scroll smoothly to the bottom of the body
    const div = document.getElementById(id);
    $('#' + id).animate({
        scrollTop: div.scrollHeight - div.clientHeight + $("#footer").height() * 2  // todo: fix "$("#footer").height() * 2" later. It doesn't scroll down to the bottom when it loads at the first time
    }, 500);
}
</script>

<html>
<body class="bg-dark" style="color: white;">
<header class="row justify-content-center m-1">
    <h1 id="title" class="text-white text-center">Let's chat with people from my favourite movie Titanic</h1>
</header>
<main class="m-2" id="main">
    <div class="container-fluid">
        <div id="messages" class="row"></div>
    </div>
</main>
<footer class="row bg-secondary align-items-center p-2 m-1" id="footer">
    <div class="dropdown">
        <button class="btn btn-secondary dropdown-toggle bg-dark" id="name" type="button" data-toggle="dropdown"
                aria-haspopup="true" aria-expanded="false">
            NAME
        </button>
        <div class="dropdown-menu bg-dark text-white" aria-labelledby="name" id="names">
            <a class="dropdown-item">JACK</a>
            <a class="dropdown-item">ROSE</a>
            <a class="dropdown-item">CAL</a>
            <a class="dropdown-item">MOLLY</a>
            <a class="dropdown-item">ISMAY</a>
            <a class="dropdown-item">ANDREWS</a>
            <a class="dropdown-item">GRACIE</a>
            <a class="dropdown-item">GUGGENHEIM</a>
            <a class="dropdown-item">WAITER</a>
        </div>
    </div>
    <textarea id="message" class="form-control bg-dark text-white m-2 col"
              placeholder="Message"></textarea>
    <button id="send" class="btn btn-success">
        <svg width="2em" height="2em" viewBox="0 0 16 16" class="bi bi-arrow-up" fill="currentColor"
             xmlns="http://www.w3.org/2000/svg">
            <path fill-rule="evenodd" d="M8 3.5a.5.5 0 0 1 .5.5v9a.5.5 0 0 1-1 0V4a.5.5 0 0 1 .5-.5z"/>
            <path fill-rule="evenodd"
                  d="M7.646 2.646a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8 3.707 5.354 6.354a.5.5 0 1 1-.708-.708l3-3z"/>
        </svg>
    </button>

    <button id="reset" class="btn btn-danger m-2">
        <svg width="2em" height="2em" viewBox="0 0 16 16" class="bi bi-arrow-counterclockwise" fill="currentColor"
             xmlns="http://www.w3.org/2000/svg">
            <path fill-rule="evenodd"
                  d="M12.83 6.706a5 5 0 0 0-7.103-3.16.5.5 0 1 1-.454-.892A6 6 0 1 1 2.545 5.5a.5.5 0 1 1 .91.417 5 5 0 1 0 9.375.789z"/>
            <path fill-rule="evenodd"
                  d="M7.854.146a.5.5 0 0 0-.708 0l-2.5 2.5a.5.5 0 0 0 0 .708l2.5 2.5a.5.5 0 1 0 .708-.708L5.707 3 7.854.854a.5.5 0 0 0 0-.708z"/>
        </svg>
    </button>
</footer>
</body>
</html>